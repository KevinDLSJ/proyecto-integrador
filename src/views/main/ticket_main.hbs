<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Nueva Venta</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      height: 100vh;
    }

    .sidebar {
      width: 220px;
      background-color: #d3e0ff;
      padding: 20px;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    }

    .sidebar a {
      display: block;
      margin-bottom: 15px;
      padding: 10px;
      text-decoration: none;
      color: #333;
      font-weight: bold;
      border-radius: 5px;
    }

    .sidebar a:hover {
      background-color: #b0c4de;
    }

    .sidebar .salir {
      background-color: #ffd700;
      color: black;
    }

    .main {
      flex-grow: 1;
      padding: 30px;
      background-color: #f9f9f9;
    }

    h1 {
      margin-top: 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }

    th {
      background-color: #e0e0e0;
    }

    button {
      padding: 8px 12px;
      margin-top: 10px;
      cursor: pointer;
    }

    #total {
      font-weight: bold;
      color: #2c3e50;
    }
  </style>
</head>
<body>

  <div class="sidebar">
    <img src="/images/logo.png" alt="Logo" style="width:100%; margin-bottom: 20px;">
    <a href="/">INICIO</a>
    <a href="/productos">PRODUCTOS</a>
    <a href="/nueva_venta">Nueva Venta</a>
    <a href="/logout" class="salir">SALIR</a>
  </div>

  <div class="main">
    <h1>Nueva Venta</h1>

    <form id="ventaForm" action="/guardar_venta" method="POST">
      <input type="hidden" name="productos" id="productosInput">

      <table id="detalle-venta">
        <thead>
          <tr>
            <th>Producto</th>
            <th>Stock</th>
            <th>Precio Unitario</th>
            <th>Cantidad</th>
            <th>Subtotal</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody>
          <!-- Filas dinámicas -->
        </tbody>
      </table>

      <button type="button" onclick="agregarFila()">Agregar producto</button>

      <h3>Total: $<span id="total">0.00</span></h3>

      <button type="submit">Confirmar Venta</button>
    </form>
  </div>

  <script>
    let productos = [];
    try {
      productos = {{{productosJSON}}} || [];
    } catch (e) {
      console.error("Error al parsear productosJSON:", e);
      productos = [];
    }

    const tbody = document.querySelector('#detalle-venta tbody');
    const totalSpan = document.getElementById('total');
    const productosInput = document.getElementById('productosInput');

    function escapeHTML(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    function agregarFila() {
      if (!Array.isArray(productos) || productos.length === 0) {
        alert("No hay productos disponibles para vender.");
        return;
      }

      const row = document.createElement('tr');

      row.innerHTML = `
        <td>
          <select onchange="actualizarPrecio(this)">
            <option value="">Seleccione</option>
            ${productos.map(p => `
              <option value="${escapeHTML(p.producto_id)}" 
                      data-precio="${escapeHTML(p.precio)}" 
                      data-stock="${escapeHTML(p.stock_actual)}">
                ${escapeHTML(p.nombre_p)}
              </option>
            `).join('')}
          </select>
        </td>
        <td class="stock">0</td>
        <td class="precio">0.00</td>
        <td><input type="number" min="1" value="1" oninput="calcularFila(this)"></td>
        <td class="subtotal">0.00</td>
        <td><button type="button" onclick="eliminarFila(this)">❌</button></td>
      `;

      tbody.appendChild(row);
    }

    function actualizarPrecio(select) {
      const row = select.closest('tr');
      const option = select.options[select.selectedIndex];
      const precio = parseFloat(option.dataset.precio || 0);
      const stock = option.dataset.stock || 0;

      row.querySelector('.precio').innerText = precio.toFixed(2);
      row.querySelector('.stock').innerText = stock;

      calcularFila(row.querySelector('input[type=number]'));
    }

    function calcularFila(input) {
      const row = input.closest('tr');
      const precio = parseFloat(row.querySelector('.precio').innerText);
      const cantidad = parseInt(input.value) || 0;
      const subtotal = precio * cantidad;

      row.querySelector('.subtotal').innerText = subtotal.toFixed(2);
      calcularTotal();
    }

    function eliminarFila(btn) {
      btn.closest('tr').remove();
      calcularTotal();
    }

    function calcularTotal() {
      let total = 0;
      const detalles = [];

      document.querySelectorAll('#detalle-venta tbody tr').forEach(row => {
        const select = row.querySelector('select');
        const id = select.value;
        const precio = parseFloat(row.querySelector('.precio').innerText);
        const cantidad = parseInt(row.querySelector('input[type=number]').value) || 0;
        const subtotal = precio * cantidad;

        if (id) {
          detalles.push({ id, cantidad, precio });
          total += subtotal;
        }
      });

      totalSpan.innerText = total.toFixed(2);
      productosInput.value = JSON.stringify(detalles);
    }

    document.getElementById('ventaForm').addEventListener('submit', function () {
      calcularTotal();
    });
  </script>
</body>
</html>
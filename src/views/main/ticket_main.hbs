<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Nueva Venta</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      height: 100vh;
    }

    .sidebar {
      width: 220px;
      background-color: #d3e0ff;
      padding: 20px;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    }

    .sidebar a {
      display: block;
      margin-bottom: 15px;
      padding: 10px;
      text-decoration: none;
      color: #333;
      font-weight: bold;
      border-radius: 5px;
    }

    .sidebar a:hover {
      background-color: #b0c4de;
    }

    .sidebar .salir {
      background-color: #ffd700;
      color: black;
    }

    .main {
      flex-grow: 1;
      padding: 30px;
      background-color: #f9f9f9;
    }

    h1 {
      margin-top: 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }

    th {
      background-color: #e0e0e0;
    }

    button {
      padding: 8px 12px;
      margin-top: 10px;
      cursor: pointer;
    }

    #total {
      font-weight: bold;
      color: #2c3e50;
    }
  </style>
</head>
<body>

  <div class="sidebar">
    <img src="/images/logo.png" alt="Logo" style="width:100%; margin-bottom: 20px;">
    <a href="/">INICIO</a>
    <a href="/productos">PRODUCTOS</a>
    <a href="/nueva_venta">Nueva Venta</a>
    <a href="/logout" class="salir">SALIR</a>
  </div>

<div class="main">
  <h1>Nueva Venta</h1>


  <input type="text" id="buscadorProducto" placeholder="Buscar producto...">
  <div id="resultadosBusqueda" class="resultados"></div>

  <form id="ventaForm" action="/guardar_venta" method="POST">
    <input type="hidden" name="productos" id="productosInput">

    <table id="detalle-venta">
      <thead>
        <tr>
          <th>Producto</th>
          <th>Stock</th>
          <th>Precio Unitario</th>
          <th>Cantidad</th>
          <th>Subtotal</th>
          <th>Acción</th>
        </tr>
      </thead>
      <tbody>
  
      </tbody>
    </table>

    <h3>Total: $<span id="total">0.00</span></h3>

    <button type="submit">Confirmar Venta</button>
  </form>
</div>


<style>
  .resultados {
    position: absolute;
    background: white;
    border: 1px solid #ccc;
    width: 300px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 10;
  }
  .resultado-item {
    padding: 5px;
    cursor: pointer;
  }
  .resultado-item:hover {
    background-color: #f0f0f0;
  }
</style>


<script>

  let productos = [];
  try {
    productos = {{{productosJSON}}} || [];
  } catch (e) {
    console.error("Error al parsear productosJSON:", e);
    productos = [];
  }


  const tbody = document.querySelector('#detalle-venta tbody');
  const totalSpan = document.getElementById('total');
  const productosInput = document.getElementById('productosInput');
  const buscador = document.getElementById('buscadorProducto');
  const resultadosDiv = document.getElementById('resultadosBusqueda');



  function escapeHTML(str) {
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
  }


  buscador.addEventListener('input', () => {
    const texto = buscador.value.toLowerCase().trim();
    resultadosDiv.innerHTML = '';

    if (!texto) return;

    const filtrados = productos.filter(p => 
      p.nombre_p.toLowerCase().includes(texto)
    );

    filtrados.slice(0, 5).forEach(p => {
      const item = document.createElement('div');
      item.classList.add('resultado-item');
      item.innerText = `${p.nombre_p} (Stock: ${p.stock_actual}, $${p.precio})`;
      item.onclick = () => {
        agregarOActualizarFila(p);
        resultadosDiv.innerHTML = '';
        buscador.value = '';
      };
      resultadosDiv.appendChild(item);
    });
  });


  function agregarOActualizarFila(p) {

    const filaExistente = [...tbody.querySelectorAll('tr')].find(
      row => row.dataset.productoId == p.producto_id
    );

    if (filaExistente) {

      const cantidadInput = filaExistente.querySelector('input[type=number]');
      const nuevaCantidad = Math.min(
        parseInt(cantidadInput.value) + 1,
        p.stock_actual
      );
      cantidadInput.value = nuevaCantidad;
      calcularFila(cantidadInput);
      return;
    }

 
    const row = document.createElement('tr');
    const subtotal = parseFloat(p.precio).toFixed(2);

    row.innerHTML = `
      <td>${escapeHTML(p.nombre_p)}</td>
      <td class="stock">${p.stock_actual}</td>
      <td class="precio">${parseFloat(p.precio).toFixed(2)}</td>
      <td>
        <input type="number" min="1" max="${p.stock_actual}" value="1" 
               oninput="calcularFila(this)">
      </td>
      <td class="subtotal">${subtotal}</td>
      <td><button type="button" onclick="eliminarFila(this)">❌</button></td>
    `;

    row.dataset.productoId = p.producto_id; 

    tbody.appendChild(row);
    calcularTotal();
  }


  function calcularFila(input) {
    const row = input.closest('tr');
    const precio = parseFloat(row.querySelector('.precio').innerText);
    const cantidad = parseInt(input.value) || 0;
    const stock = parseInt(row.querySelector('.stock').innerText);


    if (cantidad > stock) {
      input.value = stock;
      return calcularFila(input);
    }

    const subtotal = precio * cantidad;
    row.querySelector('.subtotal').innerText = subtotal.toFixed(2);
    calcularTotal();
  }


  function eliminarFila(btn) {
    btn.closest('tr').remove();
    calcularTotal();
  }


  function calcularTotal() {
    let total = 0;
    const detalles = [];

    document.querySelectorAll('#detalle-venta tbody tr').forEach(row => {
      const id = row.dataset.productoId;
      const precio = parseFloat(row.querySelector('.precio').innerText);
      const cantidad = parseInt(row.querySelector('input[type=number]').value) || 0;
      const subtotal = precio * cantidad;

      if (id) {
        detalles.push({ id, cantidad, precio });
        total += subtotal;
      }
    });

    totalSpan.innerText = total.toFixed(2);
    productosInput.value = JSON.stringify(detalles);
  }


  document.getElementById('ventaForm').addEventListener('submit', function () {
    calcularTotal();
  });
</script>

</body>
</html>